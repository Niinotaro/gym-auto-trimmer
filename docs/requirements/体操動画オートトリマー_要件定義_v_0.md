# 体操動画オートトリマー 要件定義 v0.1（鉄棒PoC優先）
- 作成日：2025-10-31
- 作成者：ChatGPT（ヒアリング反映）
- 対象：個人利用、鉄棒の技トリミングPoCを最優先

---

## 1. 目的・スコープ
- **目的**：練習動画（スマートフォン想定）から「余計な箇所を除いた**技単位のクリップ**」を自動生成。
- **スコープ（v0.1）**：鉄棒のみ / 1台カメラ（固定 or 手持ち）/ ローカルWebアプリ / GPU使用。
- **将来拡張**：他器具（床・平行棒・跳馬…）、Googleフォト取り込み、メタデータ（JSON/タグ）。

## 2. 用語
- **技**：器具に接触して開始し、離脱/着地で終了する一連の動作。近接する複数技は一定条件で連結。
- **クリップ**：検出した技区間に前後余白を付けて切り出した動画。

## 3. 機能要件（FR）
**FR-1 入力**
- FR-1.1 ブラウザのドラッグ&ドロップ / フォルダ一括選択で動画投入。
- FR-1.2 受入フォーマット：MOV/MP4（H.264/HEVC, 可変fps可）。

**FR-2 前処理**
- FR-2.1 軽量スタビライズ（手持ち時、有効化ON/OFF可）。
- FR-2.2 器具ROI初期化：鉄棒の位置を1回だけ簡易指定（矩形 or 水平線）。

**FR-3 検出（鉄棒）**
- FR-3.1 「器具接触」優先で技開始判定（開始姿勢は補助）。
- FR-3.2 「器具からの離脱/着地」優先で技終了判定（終了姿勢静止は補助）。
- FR-3.3 主被写体は「画面中央付近」かつ「器具ROIと人物の交差」で推定。
- FR-3.4 連結基準：**無動作/非接触 0.8s 以下**は自動連結。
- FR-3.5 最小長：1.0s 未満は隣接区間と自動連結（可能なら）。

**FR-4 出力**
- FR-4.1 クリップ前後余白：開始前 **0.1s** / 終了後 **0.1s**。
- FR-4.2 エンコード：解像度＝入力そのまま、**30fps CFR**、H.264/MP4、音声=元のまま。
- FR-4.3 命名：`{YYYYMMDD}_{apparatus}_{seq}.mp4`（個人利用、名前無し）。

**FR-5 UI/UX**
- FR-5.1 タイムライン：モーション量トラック＋器具スコアトラックの2段可視化。
- FR-5.2 手直し：境界ドラッグ、結合/分割、ラベル付け。
- FR-5.3 キー操作：←/→=0.1s移動、Shift+←/→=1.0s、J/K=前後クリップ移動。

**FR-6 ログ/運用**
- FR-6.1 失敗例キュー（再学習/チューニング用に時刻・縮小プレビュー保存）。
- FR-6.2 中断復帰：途中結果JSON（検出区間、閾値、バージョン）を保存。

**FR-7 将来**
- FR-7.1 跳馬例外：**「跳馬接触1s前〜着地後0.2s」**（v>0.1対応）。
- FR-7.2 Googleフォト取り込み（将来オプション）。

## 4. 非機能要件（NFR）
- **NFR-1 性能**：GPU使用時、1時間動画の処理時間 0.5〜1.0×（入力長）。
- **NFR-2 精度KPI**：検出漏れ率 ≤10% / 誤検出率 ≤10% / 開始・終了誤差 **±1.0s**。
- **NFR-3 信頼性**：例外時リトライ、クラッシュ復帰（一時ファイル/JSON）。
- **NFR-4 バージョン管理**：設定JSON＋検出器バージョンIDを成果物と同梱。
- **NFR-5 プライバシー**：ローカル完結。映り込みぼかし=オフ（個人利用）。

## 5. 入出力仕様
**入力**
- 動画：iPhone想定（HEVC/H.265 or H.264, 30fpsを含む可変fps、屋内明所、人混み=中）。

**出力**
- クリップ：H.264/MP4、30fps CFR、解像度=入力据え置き、音声=元のまま。
- 命名例：`20251105_hbar_001.mp4`（器具IDは `hbar`）。
- （将来）メタ：JSON（開始/終了時刻、器具、信頼度、検出器ver）。

## 6. 検出ロジック（初期案：鉄棒）
1) **人物検出**：軽量物体検出器（例：YOLO系n/s相当）で人物BBox抽出。
2) **ポーズ/キーポイント（簡易）**：手首・肩・腰の存在/安定度を参照（高頻度で未検出なら人物のみで代替）。
3) **器具ROI**：初期化時に鉄棒の位置を指定（矩形/線）。
4) **接触推定**：
   - 手首KPまたは人物BBoxが器具ROIと**交差**する比率が閾値以上（例：>5〜10%）。
   - 連続Nフレーム成立で「接触安定」。
5) **開始・終了**：
   - 開始=接触安定 上昇でトリガ。
   - 終了=ROI非交差が連続Mフレーム または 着地検知（人物重心yの急上昇→地面付近で水平速度低下）。
6) **区間確定**：ヒステリシス平滑＋ギャップ≤0.8s連結、最小1.0s未満は近傍と統合。
7) **切出し**：前0.1s/後0.1s余白、30fpsCFR、H.264/MP4へ再エンコード。

> ※ 跳馬は将来：踏切板/跳馬の接触イベントを別器具ロジックで扱う。

## 7. 精度評価
- **評価粒度**：±1.0s 許容での区間IoU（区間F1）。
- **手順**：10〜20本に手動ラベル（開始/終了/器具）→ Precision/Recall、区間F1、平均境界誤差を算出。
- **失敗分析**：オクルージョン/手ブレ/被写体誤選択/器具ROI誤差。

## 8. UX概要（ワイヤ骨子）
1) **ホーム**：動画投入（DnD/フォルダ）。
2) **器具ROIセット**（初回のみ）：鉄棒位置をワンクリックで矩形/線指定。
3) **検出結果画面**：
   - タイムライン：モーション量（上段）/器具スコア（下段）。
   - クリップ一覧：サムネ＋長さ。クリックでプレビュー。
   - 手直し：境界ドラッグ、結合/分割、ラベル入力。
4) **書き出し**：全書き出し or 選択書き出し（命名規則固定）。

## 9. システム構成（PoC）
- **フロント**：Web（ローカル）/ React系 or 既存UIフレーム。動画プレビュー、タイムライン。
- **バック**：Python + PyTorch/OpenCV/FFmpeg バックエンドAPI。
- **推論**：GPU（CUDA）利用。軽量人物検出 + 簡易ポーズ。
- **永続化**：プロジェクトフォルダ配下に `/clips`, `/cache`, `/logs`, `/meta`。
- **ハード目安**：GPU 8GB VRAM相当（例：RTX 3060級）、RAM16GB、SSD。

## 10. ログ・監視・再現性
- 失敗例キュー（時刻・縮小画像・理由タグ）。
- 主要パラメータ・モデルID・閾値をJSON保存。
- 同一入力に対し同一出力が再現可能（バージョン/設定固定）。

## 11. マイルストーン
- **M0（本ドキュ承認）**：要件FIX。
- **M1（PoC-鉄棒）**：検出→トリミング→UI手直し→書き出しまで一連（KPI暫定）。
- **M2（評価）**：10〜20本でKPI測定、パラメータ調整、スタビ有効化判定。
- **M3（機能強化）**：メタJSON/タグ、Googleフォト取り込み検討、他器具拡張計画。

## 12. 受け入れ基準（Acceptance）
1) 鉄棒の技区間が**90%以上**で検出成功（漏れ≤10%）。
2) 誤検出率≤10%。
3) 区間境界の平均誤差≤**±1.0s**（ラベル基準）。
4) 1時間動画の処理が**実時間〜2倍**以内（GPU使用）。
5) UIで境界手直し・結合/分割・書き出しが正常動作。

## 13. オープン項目（要確認）
1) **解像度の上限**：4K入力を標準対象に含めますか（デフォルトは含む想定、VRAM次第）。
2) **器具ROIの指定UI**：矩形と水平線どちらを初期採用？（鉄棒なら水平線でも可）。
3) **スタビライズ既定**：固定カメラ時は自動OFFにしますか（初期は自動判定ON→固定ならOFF）。
4) **ログ保存期間**：`/logs` の保持期間（デフォルト30日）。
5) **フォルダ監視**：v0.1で対応するか（初期はDnDのみ、監視はM2以降でも可）。

---

### 付録A：想定コマンド（参考）
```bash
# 例: バックエンドCLI（内部用）
trim-gym --apparatus hbar \
  --input path/to/video.mov \
  --roi "x=200,y=120,w=1400,h=120" \
  --gap-merge-sec 0.8 --min-len-sec 1.0 \
  --pad-pre 0.1 --pad-post 0.1 \
  --out-dir ./clips --cfr 30
```

